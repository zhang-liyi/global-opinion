--- 
title: "Factors Behind Global Opinions"
author: "Xingyu Wei, Liyi Zhang"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction


<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Introduction

Covid-19 significantly impacts world politics, and China has become an increasingly prominent player on the world stage. This project studies major factors that influence global attitudes toward China, and examines the ways these factors interact with each other. It is clear that global public opinions toward China dropped significantly as measured before and after covid. We investigate how covid’s effect on individuals and factors other than covid interact to influence opinions toward China. Specifically, we discover that the impact of factors differ when applied to individuals or countries. Economic situation, how much covid impact livelihood, and perception on how China handled covid are significant in influencing individual opinions. However, only perception on how China handled covid correlates whether a country overall tends more to favor or disfavor China.

We draw inspirations from a similar study conducted by the Pew Research Center: [Unfavorable Views of China Reach Historic Highs in Many Countries](https://www.pewresearch.org/global/2020/10/06/unfavorable-views-of-china-reach-historic-highs-in-many-countries/). Both studies identify factors connected with increasingly negative views towards China. However, our study differs by analyzing factors on an individual level, whereas the original study analyzes national trends. Additionally, our study features interactions among three or more variables that are absent in the original study. 

<!--chapter:end:01-introduction.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

Our dataset is survey data provided by Pew Research Center. Its website contains a [global research datasets section](www.pewresearch.org/global/datasets/), and it is from here that we draw multiple years' survey data. 

The survey is conducted across advanced economies, with questions focusing on global attitudes. Typical questions include opinion towards particular countries, towards own country's economy, and towards concepts such as globalization. Dataset from year 2020 particularly contains question on Covid-19, such as how much covid affected one's life in general. 

The questions consist mainly of multiple choices, and it is only multiple choices that we use in our project. The survey is conducted on over 10,000 individuals.

The survey is conducted by Pew Research Center, following general international survey methodologies that are also specified in detail in their [official website](https://www.pewresearch.org/methodology/international-survey-research/international-methodology/all-survey/all-country/all-year). 

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

The data is a .sav file, and data transformation is quite simple once the datasets are downloaded and put in the same folder. It is also necessary to install the package `haven` to read .sav file.

```{r}
library(haven)

dataset <- read_sav('dataset.sav')
```

We can take a peek at the dataset:

```{r}
head(dataset)
```

Each row is an individual response. To the individual is attached country, and answers to a number of multiple choice questions. Notice that there is also a `weight` column. Intructions from the source specify that answers must be weighted when used to compute the sum or mean response.

There is more nuanced, task-specific data transformation needed for different plots and tasks, which we introduce later. A general guideline for the data transformation codes later is that, one can use the `mutate` and `as_factor` function to create discrete versions of columns convenient for plotting. In particular, `as_factor` allows one to utilize the special <dbl+lbl> format of columns and allow graphs to output interpretable labels.

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

We select 14 survey questions. Each question is a multiple choice question with choices: I don't know or refuse to answer. We identify these choices as missing data and plot and analyze the missing data pattern.

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=12) 
```

Now we plot missing data.

```{r}
source("plot_missing.R")
library(haven) # reads .sav file

# Read data and select a portion of it
dataset <- read_sav('dataset.sav')
selected_data <- dataset[,c(6:16,22,23,84)]
num_col <- dim(selected_data)[2]
num_row <- dim(selected_data)[1]

# Identify missing data
# 8 & 9 stand for missing data in this context
for(c in 1:num_col){
  idx <- which(selected_data[,c]==9 | selected_data[,c]==8)
  selected_data[idx, c] <- NA
}

# Select a sub-sample for plotting
samp <- sample(1:num_row, 300)
selected_data <- selected_data[samp,]

# Plot
plot_missing(selected_data, percent=TRUE, x_vert=TRUE)
```

From the missing value pattern plot, we see that the data is quite complete, with complete data being by far the most common pattern, and the survey question with largest missing rate has only about 10% answers missing. 

There is no significant pattern on correlations between features (survey questions) with missing answers. 

Looking at percentage of rows missing, we find that more abstract questions related to COVID tend to have more missing answers. For example, covid_countryfaith, which means whether the respondent thinks the country has more or less religious faith after the COVID outbreak, has more missing answers than most. Questions like economic situation (econ_sit) and how COVID affects family bond (covid_family), which are less abstract, have fewer missing answers. This pattern is reasonable. Plotting from a subsample of data causes variations, but this pattern has been consistent.



<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

(Some of the code will eventually be put in other sections)

```{r setup, include=FALSE}
# knitr::opts_chunk$set(fig.width=8, fig.height=12) 
```

```{r}
library(haven)
library(tidyverse)
library(ggmosaic)
library(ggalluvial)
library(patchwork)
library(Lock5withR)

dataset <- read_sav('dataset.sav')
cols_index_df = data.frame(colnames(dataset))

drop_na_custom <- function(df, cols_index) {
  df <- df[,cols_index]
  num_col <- dim(df)[2]
  num_row <- dim(df)[1]
  for(c in 1:num_col){
    idx <- which(df[,c]==9 | df[,c]==8)
    df[idx, c] <- NA
  }
  df <- df %>%
    drop_na()
  return(df)
}
```

```{r}
df <- drop_na_custom(dataset,c(5,6,16))

df <- df %>%
  mutate(fav_China_discrete = droplevels(fct_rev(as_factor(fav_China))),
         covid_change_discrete = droplevels(fct_rev(as_factor(covid_change))))

g1 <- ggplot(df) +
  geom_mosaic(aes(weight=weight,
                  x=product(fav_China_discrete, covid_change_discrete),
                  fill=fav_China_discrete)) +
  xlab("Covid Change") +
  ylab("Opinion on China") +
  labs(title='')+
  theme(legend.position="none")
g1
```

People who are more affected by the COVID-19 pandemic tend to have more unfavorable views of China. The rate of people's most negative views of China was highest in the group most affected by the pandemic, while the rate of people's most positive views of China was highest in the group not affected by the pandemic. Also, as shown by the dividing line between the blue and green areas, the ratio of unfavorable views to favorable views increases with the impact of the pandemic. 

Therefore, the COVID-19 pandemic may increase people's dislike of China to some extent. To further illustrate the relationship between the COVID-19 and people’s opinions on China. We will investigate more immediate results, that is, people’s opinions on how well China has handled the coronavirus pandemic.

```{r}
df <- drop_na_custom(dataset,c(5,16,23))

df <- df %>%
  mutate(fav_China_discrete = droplevels(fct_rev(as_factor(fav_China))),
         covid_china_discrete = droplevels(as_factor(covid_china)))

g2 <- ggplot(df) +
  geom_mosaic(aes(weight=weight,
                  x=product(fav_China_discrete, covid_china_discrete),
                  fill=fav_China_discrete)) +
  xlab("Opinion on China's response to COVID-19") +
  ylab("Opinion on China") +
  labs(title='')+
  theme(legend.position="none")
g2
```

The correlations here are much more apparent, as shown in the stepped pattern of this mosaic plot. Moreover, in the previous graph, the majority of each group expresses negative views toward China. However, in the current graph, the majority of people who say China has done a very good job dealing with the coronavirus outbreak think of China positively. This significant difference reveals that people’s evaluations of China’s response to COVID-19 can greatly affect people’s opinion on China. Moreover, the results of people’s opinions on China and China’s response to Covid-19 are very consistent. People who think China has handled the coronavirus outbreak poorly have more negative evaluations on China and vice versa. 

Covid-19 will affect other aspects, such as the economy, and indirectly affect people's evaluation of China. People who are in different economic situations may have different opinions on China. Also, people who are in bad economic situations are more likely to be influenced by the pandemic and hence have a bad attitude toward China. We will then analyze how opinions on China were affected by the economic situation and covid effect on life respectively and interactively.

```{r}
df <- drop_na_custom(dataset,c(5,16,13))
df <- df %>%
  mutate(fav_China_discrete = droplevels(fct_rev(as_factor(fav_China))),
         econ_sit_discrete = droplevels(as_factor(econ_sit)))
g3 <- ggplot(df) +
  geom_mosaic(aes(weight=weight,
                  x=product(fav_China_discrete, econ_sit_discrete),
                  fill=fav_China_discrete)) +
  xlab("Economic situation") +
  ylab("Opinion on China") +
  labs(title='')+
  theme(legend.position="none")

df <- drop_na_custom(dataset,c(5,6,13))
df <- df %>%
  mutate(covid_change_discrete = droplevels(fct_rev(as_factor(covid_change))),
         econ_sit_discrete = droplevels(as_factor(econ_sit)))

g4 <- ggplot(df) +
  geom_mosaic(aes(weight=weight,
                  x=product(covid_change_discrete, econ_sit_discrete),
                  fill=covid_change_discrete)) +
  xlab("Economic situation") +
  ylab("Covid Change") +
  labs(title='')+
  theme(legend.position="none")

layout <- "
AB
#C
"
g5 = g1 + g3 + g4+
  plot_layout(design = layout)
g5
```

All the three subgraphs are consistent with what we intuitively expected. People affected most by the covid are more likely to have unfavorable opinions on China; People in bad economic situations are more likely to have unfavorable opinions on China; People in bad economic situations are more likely to be affected by the covid. Then we consider all these three variables in an integrated graph.

```{r}
df <- drop_na_custom(dataset,c(5,6,13,16))
df <- df %>%
  mutate(fav_China_discrete = droplevels(fct_rev(as_factor(fav_China))),
         covid_change_discrete = droplevels(as_factor(covid_change)),
         econ_sit_discrete = droplevels(as_factor(econ_sit)))
g6 <- ggplot(df) +
  geom_mosaic(aes(weight=weight,
                  x=product(fav_China_discrete, econ_sit_discrete, covid_change_discrete),
                  fill=fav_China_discrete)) +
  labs(title='')+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
g6

library(vcd)
vcd::mosaic(fct_rev(fav_China_discrete) ~ covid_change_discrete+econ_sit_discrete, df,
            direction=c('v','v','h'),
            highlighting_fill=c('lightblue','blue','grey','black'))
```

From the graph, the horizontal line separating positive opinions and negative opinions goes down as the effect on people's life decreases. Hence, we can conclude that people who are not affected by the covid at all are much likely to have unfavorable opinions on China than any other group. Moreover, the vertical line separating good economic situations and bad economic situations moves to the right as opinions on China becomes better, which suggests that among people who have bad views of China people in bad economic conditions make up a much larger proportion. Besides, the purple region proportion decreases from left to right, indicating that people in bad economic conditions are likely to be greatly affected by the covid.

Next, we study whether the factors studied above apply across countries. That is, for factors significant on an individual-level, we ask whether these factors can indicate a country's overall opinion towards China. We find that it is not always true.

```{r}
df <- drop_na_custom(dataset, c(3,5,6,13,16,23))
num_col <- dim(df)[2]
num_row <- dim(df)[1]
df <- df %>%
  mutate(country_discrete = droplevels(as_factor(country)),
         fav_China_discrete = droplevels(as_factor(fav_China)),
         covid_change_discrete = droplevels(as_factor(covid_change)),
         econ_sit_discrete = droplevels(as_factor(econ_sit)),
         covid_china_discrete = droplevels(as_factor(covid_china)))

# country_count counts the number of rows for each country
country_count <- df %>%
  group_by(country) %>%
  summarize(count=sum(n()))

# The following assigns a nation-wide drop in opinion to each row
get_opinion_value <- function(value_vec){
  vec_weighted <- rep(0, num_row)
  vec_unweighted <- rep(0, num_row)
  for(i in 1:num_row){
    country <- as.integer(df[i, 'country'])
    idx_in_tbl <- which(country_count$country==country)
    weight <- country_count[idx_in_tbl, 'count']
    vec_weighted[i] <- value_vec[country] / weight
    vec_unweighted[i] <- value_vec[country] 
  }
  return(list(vec_weighted, vec_unweighted))
}

```
```{r}
percent_unfavorable <- c(81,71,73,75,70,71,62,0,0,75,63,85,74,73)
lst <- get_opinion_value(percent_unfavorable)
vec2_w <- unlist(lst[[1]])
vec2_u <- unlist(lst[[2]])

# Bar chart
g_bar1 <- ggplot(df, aes(weight=weight,
                         x=reorder(country_discrete, vec2_u),
                         y=vec2_w,
                         fill=econ_sit_discrete)) + 
          geom_col() +
          coord_flip() +
          xlab('Country') +
          ylab('Percentage unfavorable towards China')
g_bar1

g_bar2 <- ggplot(df, aes(weight=weight,
                         x=reorder(country_discrete, vec2_u),
                         y=vec2_w,
                         fill=covid_change_discrete)) + 
          geom_col() +
          coord_flip() +
          xlab('Country') +
          ylab('Percentage unfavorable towards China')
# g_bar2

g_bar3 <- ggplot(df, aes(weight=weight,
                         x=reorder(country_discrete, vec2_u),
                         y=vec2_w,
                         fill=covid_china_discrete)) + 
          geom_col() +
          coord_flip() +
          xlab('Country') +
          ylab('Percentage unfavorable towards China')
g_bar3

```

Bars in figure XX and XX indicate countries, ranked by percentage of respondents with unfavorable opinions towards China (very unfavorable plus somewhat unfavorable). They are colored by percentages of respondents corresponding to the labelled group. These by-country graphs show interesting differences from by-individual mosaic plots. 

Figure XX shows that the correlation between economic situation and opinion towards China does not apply across country. This figure shows no clear pattern, meaning that economics situation does not indicate whether the country is more unfavorable towards China. On the other hand, the mosaic plot (Figure XX) shows that an individual is more likely to be unfavorable towards China if he/she thinks the economic situation is bad. Therefore, economic situation is one such factor that is significant for individuals but not for countries.

On the other side, perception on China's handling of Covid applies not only on the individual level but also across countries. In figure XX, the bottom countries, i.e. those less unfavorable towards China, tend to have fewer percentages thinking that China handled Covid very or somewhat badly. This factor has also been shown to be very significant on the individual level (figure XX).

```{r}
drop_in_opinions <- c(24,0,6,0,8,15,5,0,0,12,10,15,19,13)
lst <- get_opinion_value(drop_in_opinions)
vec1_w <- unlist(lst[[1]])
vec1_u <- unlist(lst[[2]])

# Bar chart
g_bar1 <- ggplot(df, aes(weight=weight, 
                     x=reorder(country_discrete, vec1_u),
                     y=vec1_w,
                     fill=econ_sit_discrete)) + 
          geom_col() +
          coord_flip() +
          xlab('Country') +
          ylab('Drop in attitude towards China')
#g_bar1

g_bar2 <- ggplot(df, aes(weight=weight, 
                         x=reorder(country_discrete, vec1_u),
                         y=vec1_w,
                         fill=covid_change_discrete)) + 
          geom_col() +
          coord_flip() +
          xlab('Country') +
          ylab('Drop in attitude towards China')
#g_bar2

g_bar3 <- ggplot(df, aes(weight=weight, 
                         x=reorder(country_discrete, vec1_u),
                         y=vec1_w,
                         fill=covid_china_discrete)) + 
  geom_col() +
  coord_flip() +
  xlab('Country') +
  ylab('Drop in attitude towards China')
g_bar3
```

Before, we analyzed correlations, and find idea bout how China handled Covid to be most significant. However, we do not know if this idea led to unfavorable opinions, or vice versa. To get a better idea, we study whether idea about China's handling Covid is related a drop in public opinions (increase in unfavorabe percentage) from 2019 to 2020. 

Figure XX is a similar barchart, but countries are now ranked by drop in opinion towards China. We see correlation also bewteen this factor and drop in opinion. Therefore, it is likely that opinion on how China handled Covid is one of the causes of unfavorable opinion towards China today.

That said, these two factors can also be interlinked. We do not know whether unfavorable opinion towards China inherent in 2019 also caused negative perceptions of the way China handled Covid.

Last, we focus our analysis on people in the U.S. 

```{r}
df <- drop_na_custom(dataset,c(105:107,16))
group_cols = colnames(df)
num_row = dim(df)[1]
set.seed(123)
samp <- sample(1:num_row, 100,)
df1 <- df[samp,]
df2 <- df1 %>%
  group_by(across(all_of(group_cols))) %>%
  summarise(n = n()) 
dfl <- to_lodes_form(df2, axes = 1:4)
g7 <- ggplot(dfl, aes(alluvium = alluvium, x = x, stratum = stratum, y = n)) +
  geom_alluvium(color = "blue") +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum))))

df <- drop_na_custom(dataset,c(109,110,16))
group_cols = colnames(df)
num_row = dim(df)[1]
set.seed(123)
samp <- sample(1:num_row, 100)
df1 <- df[samp,]
df2 <- df1 %>%
  group_by(across(all_of(group_cols))) %>%
  summarise(n = n()) 
idx1 <- which(df2[,1]==1)
idx2 <- which(df2[,1]==1)
df[idx1, 1] <- 2
df[idx2, 1] <- 1
idx1 <- which(df2[,2]==1)
idx3 <- which(df2[,2]==3)
df[idx1, 2] <- 3
df[idx3, 2] <- 1
dfl <- to_lodes_form(df2, axes = 1:3)
g8<- ggplot(dfl, aes(alluvium = alluvium, x = x, stratum = stratum, y = n)) +
  geom_alluvium(color = "blue") +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = paste(after_stat(stratum))))
layout <- "
A
B
"
g9 = g7 + g8+
  plot_layout(design = layout)
g9

```

‘econ_ties_china’ shows people’s opinions on economic ties between the U.S. and China. The larger the number is, the worse economic ties are. ‘china_tough’ shows people’s opinions on economic and trade policy toward China. 1 represents no tougher economic relationship, while 2 represents a tougher economic relationship. ‘china_us_enemy’ represents the relationship between China and the U.S. 1 represents a partner, 2 represents a competitor, and 3 represents an enemy.

From the first alluvial graph, data in the lower half part of each column are very likely to stay on the lower part, indicating that people who have negative feelings toward China will always give bad evaluations on China in any aspect. Also, the last two columns are much more consistent. As we expected, people who regard China as an enemy are very likely to have unfavorable opinions on China.

The larger the ‘china_covid_blame’ is, the more China should be blamed for its initial handling of the coronavirus outbreak. The larger the ‘china_covid_response’ is, the more China should be responsible for the outbreak of the coronavirus regardless of relations between the U.S. and China.
The second alluvial graph is much tidier than the first one, indicating that people have more complicated opinions on politics than those on a sudden event. Also, the first two columns are consistent with each other since they are similar questions except that the latter included political concerns. Surprisingly, in the U.S., there is still a big difference between opinions on China’s response to the Covid-19 and opinions on China.


<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component

The map provides a holistic view of percent of unfavorable opinion towards China across many countries. Viewing the opinions change on the move shows that 2020 features a particularly large increase. This further suggests the impact of Covid on global opinion towards China. 

For some reason, `iframe` cannot output the map, a problem we haven't yet solved. To view the map, one can open and view the .html file itself, which should give correct outputs.

<iframe src="interactive.html" width="1200" height="800"></iframe>


<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

---
title: "PSet 4"
output:
  html_document: default
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r setup, include=FALSE}
# this prevents package loading message from appearing in the rendered version of your problem set
knitr::opts_chunk$set(warning = FALSE, message = FALSE,
                      echo = TRUE)
```

Note: Grading is based both on your graphs and verbal explanations. Follow all best practices *as discussed in class*, including choosing appropriate parameters for all graphs. *Do not expect the assignment questions to spell out precisely how the graphs should be drawn. Sometimes guidance will be provided, but the absense of guidance does not mean that all choices are ok.*

IMPORTANT: THIS TEMPLATE DOES NOT INCLUDE THE SAMPLE GRAPHS THAT APPEAR IN THE .HTML VERSION OF THE ASSIGNMENT SO BE SURE TO VIEW THAT FILE AS WELL.

### 1. `mycars` missing patterns

Create a missing values plot for the `mycars` dataset created below (slightly different from the one in the lecture slides). Your plot should be in the style of `extracat::visna()` (no longer available on CRAN) using **ggplot2** to create the main plot and two side plots and **patchwork** to put them together. It should show accurately: missing patterns,  counts for missing by column and missing by pattern, and make it clear which row respresents complete cases. Bars in the side plots should be sorted and correspond to the rows and columns of the main plot. An example is provided though the aesthetics of your plot do not have to conform precisely to the example. Some code is provided to get you started with finding missing patterns. (Keep in mind that in the next question you will be turning this code into a function so to save yourself time later on write as generically as possible.)

```{r}
library(tidyverse)
library(patchwork)

# Add NAs to mtcars dataset
set.seed(5702)
mycars <- mtcars
mycars[1:25, "gear"] <- NA
mycars[10:20, 3:5] <- NA
for (i in 1:10) mycars[sample(32,1), sample(11,1)] <- NA
```

**Hints:**

* You can use this code to find and count the missing patterns:
```{r}
missing_patterns <- data.frame(is.na(mycars)) %>%
  group_by_all() %>%
  count(name = "count", sort = TRUE) %>%
  ungroup()
```


```{r}
tidypatterns <- missing_patterns[,1:11] %>% 
    rownames_to_column("id") %>% 
    gather(key, value, -id) 
```

```{r}
complete_bool = rowSums(missing_patterns[,1:11]) == 0
complete_row = which(complete_bool)
tidypatterns <- tidypatterns %>% 
  mutate( ToHighlight = ifelse(id %in% complete_row, "TRUE", "FALSE" ) )
tidypatterns <- tidypatterns %>% 
  mutate( color = as.factor(as.integer(!value)+as.integer(as.logical(ToHighlight))) )
```

```{r}
missing_patterns2<-missing_patterns[1:11]
missing_patterns2 <- missing_patterns2 %>% 
  mutate( ToHighlight = ifelse(rowSums(.)==0, "TRUE", "FALSE" ) )
missing_patterns['ToHighlight'] = missing_patterns2['ToHighlight']
```


```{r}
p1<-tidypatterns %>%
  mutate(key = fct_reorder(key,-value,.fun='sum')) %>%
  ggplot(aes(x = key,y = fct_rev(id), fill = color))+
  geom_tile(color = "white") +     
  scale_fill_manual(values = c('0'="purple",'1'="light grey",'2'="dark grey"))+
  #scale_alpha_manual(values = c(alpha('grey',0.1),alpha('purple',0.1)))+
  xlab('variable')+
  ylab('missing pattern')+
  guides(fill=FALSE, color=FALSE)+
  theme_bw()+
  annotate("text",x =ncol(missing_patterns)/2 ,y = nrow(missing_patterns)-complete_row+1,label = "complete cases")
```


```{r}
a = levels(fct_reorder(tidypatterns$key,-tidypatterns$value,.fun='sum'))
b = colSums(is.na(mycars))
reorder_idx <- match(a,names(b))
value = b[reorder_idx]
key = names(value)
df <- data.frame(key,value)
rownames(df) <- 1:nrow(df)
```

```{r}
p2<-ggplot(df,aes(x = reorder(key,-value),y = value)) +
  geom_col(fill = "lightblue")+
  ylab('num rows \n missing:')+
  labs(x = "")+
  ggtitle('Missing value patterns')+
  theme_bw()
  
```

```{r}
p3<-ggplot(missing_patterns,aes(x = nrow(missing_patterns):1,y = count,fill = ToHighlight)) +
  geom_col()+
  scale_x_continuous(breaks = 1:nrow(missing_patterns), labels = nrow(missing_patterns):1)+
  scale_fill_manual(values = c('FALSE'="lightblue",'TRUE'="blue"))+
  ylab('row count')+
  coord_flip()+
  theme_bw()+
  theme(axis.title.y=element_blank())+
  guides(fill=FALSE, color=FALSE)
```

```{r}
layout <- "
BBBBBB#
BBBBBB#
AAAAAAC
AAAAAAC
AAAAAAC
AAAAAAC
AAAAAAC
"
p1 + p2 + p3 + 
  plot_layout(design = layout)
```


* To highlight the complete cases row you need a different fill scale than the one used to show missing vs. non-missing in the main plot (purple and grey in the example). This is a little tricky since you're only allowed one fill scale in **ggplot2**. You can either use `alpha` to control the highlight with `scale_alpha_manual(values = ...)` or use the **ggnewscale** package which provides for multiple fill scales in the same graph.



### 2. Missing value plot function

a) Create a function for creating missing plots based on your code from question 1. It should provide an option to show either missing counts or missing percent. The percent option for `mycars` is shown below.

You either put the function code in a separate `.R` file or include it in the `.Rmd` file.
```{r}
source("plot_missing.R")
plot_missing(mycars, percent = TRUE)
```

b) Show the output for both options (counts / percent) for the `economics` dataset in the **ggplot2** package. (This is a test to see if your function works if there are no missing values.)
```{r}
data = economics
source("plot_missing.R")
plot_missing(data,percent=FALSE)
```
```{r}
source("plot_missing.R")
plot_missing(data,percent=TRUE)
```

c) Show the output for both options (counts / percent) for the `HollywoodMovies2011` dataset in the **Lock5withR** package. You can shorten the column names so they don't overlap in the plot.
```{r}
library(Lock5withR)
data = HollywoodMovies2011
ori_name = colnames(data)
new_name = abbreviate(ori_name,minlength = 4)
colnames(data) = new_name
source("plot_missing.R")
plot_missing(data, percent = FALSE)
```


```{r}
source("plot_missing.R")
plot_missing(data, percent = TRUE)
```


### 3. Setup your GitHub final project repo

a) Set up your final project repository following the [EDAVproject template](https://github.com/jtr13/EDAVtemplate). You can either choose one team member's GitHub account, or create an organization to house the final project. *Be sure to follow all of the steps in the README so your bookdown book renders with your information, not the placeholders in the template.* Edit the link below to point to your rendered book:

https://github.com/zhang-liyi/global-opinion

b) Make sure that all team members have write access to the repository and have practiced making contributions. Edit the link below to point to your contributors page, showing that all team members have made contributions to the repo (Note that we do not have the ability to see who has write access, only who has contributed):

https://github.com/zhang-liyi/global-opinion/graphs/contributors

c) Discuss a plan for dividing up the work for the final project and briefly summarize what each person will do.

The project has two team members: Xingyu Wei and Liyi Zhang. We will each study sub-problems that are relevant to demonstrating factors that affect global opinion. In this process, we will each do a portion of coding and written analysis specific to the sub-problems that we are each studying. So far, more specficially, Xingyu wrote the code for missing data, and Liyi gathered and cleaned the dataset and setup the GitHub.

### 4. Missing values chapter

Write a first draft of the missing values chapter of your final project. You do not have to include all of the data you use in the final project. Choose one file and analyze it using techniques discussed in class for missing values. Include a plot using your function from Q2 as well as verbal interpretation of the plot. Edit this link to point to your chapter:

https://zhang-liyi.github.io/global-opinion/missing-values.html

<!--chapter:end:PSet4.Rmd-->

